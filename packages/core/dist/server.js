(()=>{"use strict";var e={27:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=async function(e){const t=e.cleo;e.get("/api/queues",(async(e,r)=>{try{const e=t.getQueueManager(),s=await e.getAllTasks();return n.logger.info("File: queues.ts ðŸ“‹, Line: 13, Function: GET /api/Queues;",{tasksCount:s.length}),r.send({tasks:s})}catch(e){return n.logger.error("File: queues.ts âŒ, Line: 19, Function: GET /api/queues;",{error:e}),r.status(500).send({error:"Failed to fetch tasks"})}})),e.post("/api/queues",(async(e,r)=>{try{const{name:s,data:o,options:a}=e.body,i=t.getQueueManager(),u=await i.addTask(s,o,a);return n.logger.info("File: queues.ts âž•, Line: 31, Function: POST /api/queues;",{taskId:u.id,taskName:u.name}),r.send(u)}catch(e){return n.logger.error("File: queues.ts âŒ, Line: 38, Function: POST /api/queues;",{error:e}),r.status(500).send({error:"Failed to create task"})}})),e.delete("/api/queues/:taskId",(async(e,r)=>{try{const{taskId:s}=e.params,o=t.getQueueManager();return await o.removeTask(s)?(n.logger.info("File: queues.ts ðŸ—‘ï¸, Line: 51, Function: DELETE /api/queues/:taskId;",{taskId:s}),r.send({message:"Task removed successfully"})):(n.logger.warn("File: queues.ts âš ï¸, Line: 55, Function: DELETE /api/queues/:taskId;",{taskId:s,message:"Task not found"}),r.status(404).send({error:"Task not found"}))}catch(e){return n.logger.error("File: queues.ts âŒ, Line: 62, Function: DELETE /api/queues/:taskId;",{error:e}),r.status(500).send({error:"Failed to remove task"})}}))};const n=r(749)},89:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createServer=u,t.startServer=l;const s=n(r(446)),o=r(749),a=n(r(27)),i=r(783);async function u(e){const t=(0,s.default)({logger:!1});return t.cleo=e,await t.register(a.default),t.setErrorHandler(((e,t,r)=>{o.logger.error("File: server.ts âŒ, Line: 14, Function: errorHandler;",{error:e,path:t.url,method:t.method}),r.status(500).send({error:"Internal Server Error"})})),t.setNotFoundHandler(((e,t)=>{o.logger.warn("File: server.ts âš ï¸, Line: 24, Function: notFoundHandler;",{path:e.url,method:e.method}),t.status(404).send({error:"Route not found"})})),t}async function l(e,t=3001){try{const r=await u(e);await r.listen({port:t,host:"0.0.0.0"}),o.logger.info("File: server.ts ðŸš€, Line: 39, Function: startServer;",{message:`Server listening on port ${t}`})}catch(e){o.logger.error("File: server.ts âŒ, Line: 43, Function: startServer;",{error:e,message:"Failed to start server"}),process.exit(1)}}i.cleo.configure({redis:{host:"localhost",port:6379}}),l(i.cleo)},481:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.redisConnection=void 0,t.getRedisConfig=a;const n=r(749),s=6379,o="localhost";function a(){const{REDIS_HOST:e=o,REDIS_PORT:t=s,REDIS_PASSWORD:r,REDIS_TLS:a,REDIS_DB:i}=process.env;return n.logger.info("File: redis.ts ðŸ”Œ, Line: 15, Function: getRedisConfig;",{host:e,port:t,tls:"true"===a,db:i}),{host:e,port:Number(t),password:r,tls:"true"===a?{}:void 0,db:i?Number(i):void 0}}t.redisConnection=a()},361:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.task=function(e={}){return function(t,r,a){const i=a.value;a.value=async function(...t){s.logger.info("File: task.ts ðŸŽ¯, Function: task decorator;",{taskName:e.name||String(r),args:t});const a={id:e.id,priority:e.priority,maxRetries:e.maxRetries,retryDelay:e.retryDelay,timeout:e.timeout,schedule:e.schedule,queue:e.queue};try{const u=o.cleo.getQueueManager(),l=await u.addTask(e.name||String(r),t[0],a);return s.logger.info("File: task.ts âœ…, Function: task decorator;",{taskId:l.id,taskName:e.name||String(r),state:n.TaskState.PENDING}),await i.apply(this,t)}catch(t){throw s.logger.error("File: task.ts âŒ, Function: task decorator;",{taskName:e.name||String(r),error:t}),t}}}};const n=r(815),s=r(749),o=r(783)},783:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Cleo=t.Worker=t.redisConnection=t.LogLevel=t.TaskPriority=t.TaskState=t.cleo=void 0;const n=r(361),s=r(433),o=r(587);Object.defineProperty(t,"Worker",{enumerable:!0,get:function(){return o.Worker}});const a=r(815);Object.defineProperty(t,"TaskState",{enumerable:!0,get:function(){return a.TaskState}}),Object.defineProperty(t,"TaskPriority",{enumerable:!0,get:function(){return a.TaskPriority}}),Object.defineProperty(t,"LogLevel",{enumerable:!0,get:function(){return a.LogLevel}});const i=r(749),u=r(481);Object.defineProperty(t,"redisConnection",{enumerable:!0,get:function(){return u.redisConnection}});class l{static instance;queueManager;worker=null;isConfigured=!1;constructor(){i.logger.info("File: index.ts ðŸ“¦, Line: 15, Function: constructor; Initializing Cleo instance"),this.queueManager=new s.QueueManager("default")}static getInstance(){return l.instance||(i.logger.info("File: index.ts ðŸ”„, Line: 22, Function: getInstance; Creating new Cleo instance"),l.instance=new l),l.instance}configure(e){try{if(i.logger.info("File: index.ts âš™ï¸, Line: 36, Function: configure; Configuring Cleo with redis settings",{host:e.redis.host,port:e.redis.port}),!e.redis.host||!e.redis.port)throw new Error("Redis host and port are required");process.env.REDIS_HOST=e.redis.host,process.env.REDIS_PORT=e.redis.port.toString(),e.redis.password&&(process.env.REDIS_PASSWORD=e.redis.password),e.redis.tls&&(process.env.REDIS_TLS="true"),e.redis.db&&(process.env.REDIS_DB=e.redis.db.toString()),e.worker&&(i.logger.info("File: index.ts ðŸ‘·, Line: 51, Function: configure; Initializing worker"),this.worker=new o.Worker("default",e.worker)),this.isConfigured=!0,i.logger.info("File: index.ts âœ…, Line: 56, Function: configure; Cleo configuration complete")}catch(e){throw i.logger.error("File: index.ts âŒ, Line: 58, Function: configure; Configuration failed",{error:e}),e}}getQueueManager(){if(!this.isConfigured)throw i.logger.error("File: index.ts âš ï¸, Line: 64, Function: getQueueManager; Cleo must be configured before using"),new Error("Cleo must be configured before using");return this.queueManager}getWorker(){return this.worker}task=n.task}t.Cleo=l;const c=l.getInstance();t.cleo=c},433:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.QueueManager=void 0;const n=r(377),s=r(815),o=r(749),a=r(481);t.QueueManager=class{queues;constructor(e){o.logger.info("File: queueManager.ts ðŸŽ¯, Line: 9, Function: constructor;",{defaultQueueName:e}),this.queues=new Map,this.initializeQueue(e)}initializeQueue(e){const t=new n.Queue(e,{connection:a.redisConnection});this.queues.set(e,t),o.logger.info("File: queueManager.ts ðŸ†•, Line: 19, Function: initializeQueue;",{queueName:e,message:"Queue initialized"})}async addTask(e,t,r={}){const n=r.queue||"default";let a=this.queues.get(n);a||(this.initializeQueue(n),a=this.queues.get(n));const i={id:r.id||`${e}-${Date.now()}`,name:e,data:t,options:r,state:s.TaskState.PENDING,retryCount:0,createdAt:new Date,updatedAt:new Date};o.logger.info("File: queueManager.ts âž•, Line: 42, Function: addTask;",{taskId:i.id,taskName:i.name,queueName:n});const u={priority:r.priority,attempts:r.maxRetries,backoff:{type:"exponential",delay:r.retryDelay||1e3},removeOnComplete:!0,repeat:r.schedule?{pattern:r.schedule}:void 0};if(!a)throw o.logger.error("File: queueManager.ts âŒ, Line: 50, Function: addTask;",{queueName:n,message:"Queue not found"}),new Error(`Queue ${n} not found`);return await a.add(e,i,u),i}async getTask(e,t="default"){const r=this.queues.get(t);if(!r)return o.logger.error("File: queueManager.ts âŒ, Line: 65, Function: getTask;",{queueName:t,message:"Queue not found"}),null;const n=await r.getJob(e);return n?n.data:(o.logger.warn("File: queueManager.ts âš ï¸, Line: 73, Function: getTask;",{taskId:e,queueName:t,message:"Task not found"}),null)}async getTasks(e="default"){const t=this.queues.get(e);return(await(t?.getJobs())||[]).map((e=>e.data))}async getAllTasks(){return(await Promise.all(Array.from(this.queues.values()).map((async e=>e.getJobs())))).flat().map((e=>e.data))}async removeTask(e,t="default"){const r=this.queues.get(t);if(!r)return o.logger.error("File: queueManager.ts âŒ, Line: 87, Function: removeTask;",{queueName:t,message:"Queue not found"}),!1;const n=await r.getJob(e);return n?(await n.remove(),o.logger.info("File: queueManager.ts ðŸ—‘ï¸, Line: 103, Function: removeTask;",{taskId:e,queueName:t,message:"Task removed"}),!0):(o.logger.warn("File: queueManager.ts âš ï¸, Line: 95, Function: removeTask;",{taskId:e,queueName:t,message:"Task not found"}),!1)}async close(){o.logger.info("File: queueManager.ts ðŸ”’, Line: 112, Function: close;",{message:"Closing all queues"});const e=Array.from(this.queues.values()).map((e=>e.close()));await Promise.all(e),this.queues.clear()}getQueue(e){return this.queues.get(e)||null}}},815:(e,t)=>{var r,n,s,o,a;Object.defineProperty(t,"__esModule",{value:!0}),t.QueueEvent=t.WorkerState=t.LogLevel=t.TaskPriority=t.TaskState=void 0,function(e){e.PENDING="PENDING",e.RUNNING="RUNNING",e.SUCCESS="SUCCESS",e.FAILURE="FAILURE",e.RETRY="RETRY",e.SCHEDULED="SCHEDULED",e.CANCELLED="CANCELLED"}(r||(t.TaskState=r={})),function(e){e[e.LOW=1]="LOW",e[e.NORMAL=2]="NORMAL",e[e.HIGH=3]="HIGH",e[e.CRITICAL=4]="CRITICAL"}(n||(t.TaskPriority=n={})),function(e){e.ERROR="error",e.WARN="warn",e.INFO="info",e.DEBUG="debug"}(s||(t.LogLevel=s={})),function(e){e.IDLE="IDLE",e.BUSY="BUSY",e.STOPPED="STOPPED",e.ERROR="ERROR"}(o||(t.WorkerState=o={})),function(e){e.TASK_ADDED="TASK_ADDED",e.TASK_STARTED="TASK_STARTED",e.TASK_COMPLETED="TASK_COMPLETED",e.TASK_FAILED="TASK_FAILED",e.TASK_RETRYING="TASK_RETRYING",e.WORKER_CONNECTED="WORKER_CONNECTED",e.WORKER_DISCONNECTED="WORKER_DISCONNECTED"}(a||(t.QueueEvent=a={}))},749:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0,t.log=function(e,t,r){i.log(e,t,r)};const s=n(r(306)),o=r(815),a=s.default.format.combine(s.default.format.timestamp(),s.default.format.json(),s.default.format.printf((({timestamp:e,level:t,message:r,...n})=>{const s=Object.keys(n).length?JSON.stringify(n):"";return`${e} [${t.toUpperCase()}]: ${r} ${s}`}))),i=s.default.createLogger({level:process.env.LOG_LEVEL||o.LogLevel.INFO,format:a,transports:[new s.default.transports.Console({format:s.default.format.colorize({all:!0})}),new s.default.transports.File({filename:"logs/error.log",level:o.LogLevel.ERROR}),new s.default.transports.File({filename:"logs/combined.log"})]});t.logger=i,i.requestTracker=(e,t,r)=>{const n=Date.now();t.on("finish",(()=>{const r=Date.now()-n;i.info("File: logger.ts ðŸŒ, Line: 33, Function: requestTracker;",{method:e.method,url:e.url,status:t.statusCode,duration:`${r}ms`})})),r()}},587:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Worker=void 0;const n=r(377),s=r(853),o=r(815),a=r(749),i=r(481);t.Worker=class{worker;registry;state=o.WorkerState.IDLE;constructor(e,t){a.logger.info("File: worker.ts ðŸš€, Line: 14, Function: constructor;",{queueName:e,config:t}),this.registry=new s.TaskRegistry,this.worker=new n.Worker(e,this.processTask.bind(this),{connection:i.redisConnection,concurrency:t.concurrency||1}),this.setupEventHandlers()}setupEventHandlers(){this.worker.on("completed",(e=>{e&&a.logger.info("File: worker.ts âœ…, Line: 29, Function: setupEventHandlers;",{jobId:e.id,state:o.TaskState.SUCCESS})})),this.worker.on("failed",((e,t)=>{a.logger.error("File: worker.ts âŒ, Line: 36, Function: setupEventHandlers;",{jobId:e?.id,error:t,state:o.TaskState.FAILURE})})),this.worker.on("error",(e=>{a.logger.error("File: worker.ts ðŸ’¥, Line: 44, Function: setupEventHandlers;",{error:e,state:o.WorkerState.ERROR}),this.state=o.WorkerState.ERROR}))}async processTask(e){try{a.logger.info("File: worker.ts ðŸ”„, Line: 54, Function: processTask;",{jobId:e.id,state:o.TaskState.RUNNING}),this.state=o.WorkerState.BUSY;const t=e.data,r=this.registry.getTaskHandler(t.name);if(!r)throw new Error(`No handler registered for task: ${t.name}`);const n=await r(t.data);return this.state=o.WorkerState.IDLE,a.logger.info("File: worker.ts âœ…, Line: 69, Function: processTask;",{jobId:e.id,taskName:t.name,result:n}),n}catch(t){throw this.state=o.WorkerState.ERROR,a.logger.error("File: worker.ts âŒ, Line: 78, Function: processTask;",{jobId:e.id,error:t}),t}}registerTask(e,t){this.registry.registerTask(e,t)}getState(){return this.state}async close(){a.logger.info("File: worker.ts ðŸ”’, Line: 90, Function: close;",{state:o.WorkerState.STOPPED}),this.state=o.WorkerState.STOPPED,await this.worker.close()}}},853:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TaskRegistry=void 0;const n=r(749);t.TaskRegistry=class{tasks;constructor(){this.tasks=new Map,n.logger.info("File: taskRegistry.ts ðŸ“, Line: 8, Function: constructor;",{message:"Task registry initialized"})}registerTask(e,t){n.logger.info("File: taskRegistry.ts âž•, Line: 15, Function: registerTask;",{taskName:e}),this.tasks.set(e,t)}getTaskHandler(e){const t=this.tasks.get(e);return t||n.logger.warn("File: taskRegistry.ts âš ï¸, Line: 24, Function: getTaskHandler;",{taskName:e,message:"Task handler not found"}),t}async execute(e){const t=this.getTaskHandler(e.name);if(!t){const t=`No handler registered for task: ${e.name}`;throw n.logger.error("File: taskRegistry.ts âŒ, Line: 35, Function: execute;",{taskName:e.name,error:t}),new Error(t)}try{n.logger.info("File: taskRegistry.ts ðŸ”„, Line: 43, Function: execute;",{taskName:e.name,taskId:e.id});const r=await t(e.data);return n.logger.info("File: taskRegistry.ts âœ…, Line: 50, Function: execute;",{taskName:e.name,taskId:e.id,result:r}),r}catch(t){throw n.logger.error("File: taskRegistry.ts âŒ, Line: 58, Function: execute;",{taskName:e.name,taskId:e.id,error:t}),t}}}},377:e=>{e.exports=require("bullmq")},446:e=>{e.exports=require("fastify")},306:e=>{e.exports=require("winston")}},t={},r=function r(n){var s=t[n];if(void 0!==s)return s.exports;var o=t[n]={exports:{}};return e[n].call(o.exports,o,o.exports,r),o.exports}(89);module.exports=r})();